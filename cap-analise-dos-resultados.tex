%% ------------------------------------------------------------------------- %%
\chapter{Análise dos Resultados} \label{cap:analise_dos_resultados}

O estudo final foi um estudo fatorial completo (ver
Subseção~\ref{sec:experimentos_fatoriais}). A sua execução foi rápida e usou
poucos recursos devido aos estudos fatoriais 2\textsuperscript{k} feitos para
triagem dos fatores -- a execução de uma repetição do estudo final demorava 6,5
horas. O pequeno número de fatores e níveis foi importante para uma análise
consistente dos resultados. Esse fato é enfatizado pela principal referência
metodológica usada neste trabalho \cite{Jain1991} e também foi sugerido para o
autor deste trabalho em conversa com o pesquisador visitante no IME Jean-Marc
Vincent, que possui grande experiência em estudos de desempenho.

Este estudo tinha duas hipóteses principais que estão descritas na
Seção~\ref{sec:hipoteses}. A seguir, a
Seção~\ref{sec:nivel_de_confianca_exatidao_tamanho_da_amostra_e_replicacoes}
descreve o nível de confiança do estudo relativo ao tamanho da amostra. A
Seção~\ref{sec:analise_dos_tempos_de_resposta} mostra a análise dos tempos de
resposta, a Seção~\ref{sec:analise_dos_conflitos} mostra a análise dos conflitos
e a Seção~\ref{sec:analise_das_migracoes} mostra a análise das migrações. A
Seção~\ref{sec:ameacas_a_validade} descreve as ameaças à validade levantadas e
por fim, a Seção~\ref{sec:trabalhos_relacionados} apresenta os trabalhos
relacionados a este.

%% ------------------------------------------------------------------------- %%
\section{Hipóteses} \label{sec:hipoteses}

A principal hipótese deste trabalho era que um sistema georeplicado usando
consistência na linha do tempo apresentaria um desempenho competitivo com a
consistência em momento indeterminado para algumas cargas de trabalho, como uma
que apresentasse localidade alta, por exemplo. Essa hipótese se baseava em uma
segunda hipótese, a de que os tempos de resposta das requisições para o sistema
seriam dominadas pela latência (e variação da latência) da WAN. Um exemplo de
fenômeno que poderia invalidar a hipótese seria a réplica mestre se comportar
como gargalo na consistência na linha do tempo. Essa hipótese é verificada pela
distribuição acumulada dos tempos de resposta para cada modo usado no estudo.

Outra hipótese é que as proporções de conflitos identificados durante as
leituras em ambos os modelos de consistência seriam próximas. Conflitos na
consistência na linha do tempo aparecem pois atualizações são enfileiradas na
réplica mestre. Há um intervalo de tempo em que a atualização foi aplicada na
réplica mestre mas ainda não foi enviada para as outras réplicas, esse intervalo
é a janela de inconsistência. A consistência em momento indeterminado apresenta
conflitos por motivo semelhante, com a diferença que a atualização pode ser
aplicada em qualquer réplica. Desse fato resulta que a consistência em momento
indeterminado permite atualizações simultâneas e divergentes, o que não é
permitido pela consistência na linha do tempo. Assim, os conflitos no caso da
consistência em momento indeterminado são mais graves.

%% ------------------------------------------------------------------------- %%
\section{Nível de Confiança, Exatidão, Tamanho da Amostra e Replicações}
\label{sec:nivel_de_confianca_exatidao_tamanho_da_amostra_e_replicacoes}

O tamanho da amostra de um experimento é dado por:

$n = (\frac{100 * z * s}{r * \bar{x}})^2$,

onde z é o valor z relativo do nível de confiança desejado, s é o erro padrão, r
é a precisão desejada e $\bar{x}$ é a média da amostra.

O erro padrão indica o quão perto da média da população está a média da amostra,
enquando o desvio padrão indica a variação dos indivíduos de uma amostra da
média da amostra. O erro padrão é dado por:

$s = \frac{\sigma}{\sqrt{n}}$,

onde $\sigma$ é o desvio padrão da média e $n$ é o tamanho da amostra.

O nível de confiança determina o intervalo de confiança, que é um intervalo de
valores centrado na média e com uma probabilidade de que a média da população
esteja incluída nele. Por exemplo, dada uma média $\bar{x} = 100$ ms, um erro
padrão $s = 5$ ms e nível de confiança de 95\% ($z = 1,960$), o intervalo de
confiança é $(100 - 1,960 * 5, 100 + 1,960 * 5) = (90,2, 109,8)$, o que
significa que existe 95\% de chance de a média da população estar nesse
intervalo, ou que de cada 100 repetições do experimento, 95 terão a média dentro
desse intervalo.

A exatidão indica qual a distância entre uma medição da média e média da
população. No caso, a exatidão é aplicada ao intervalo de confiança, portanto o
cálculo do intervalo acima com uma exatidão de 1\% passa a ser $(100 * (1 -
0,01) - 1,960 * 5, 100 * (1 + 0,01) + 1,960 * 5) = (89,2, 110,8)$. 

O tamanho da amostra depende de conhecer a média e o erro padrão, portanto
experimentos precisam ser feitos para uma estimativa desses valores. No caso
deste estudo, o valor da média e do erro padrão variavam muito de um experimento
para outro. Por exemplo, um experimento em que todas as requisições fossem
locais apresentaria média e erro padrão menores do que um experimento em que
houvesse um balanço entre requisições locais e remotas. Por isso, a opção foi
executar todos os experimentos e depois verificar se o tamanho da amostra estava
adequado para cada um deles.
 
A configuração do \emph{benchmark} era baseada em duração, e não em quantidade
de requisições, por isso testes exploratórios foram feitos para identificar que
duração deveria ser configurada para os experimentos. Com tempo de 3 min e
repetindo os experimentos percebeu-se que havia pouca variação de média e erro
padrão. O valor mínimo de quantidade de requisições de um experimento foi 76137,
para \emph{lt\_rec}, localidade de 50\% e latência de rede de 300 ms.

Dados esses resultados, foram verificados os tamanhos da amostra dos
experimentos. Para nível de confiança de 99\% e exatidão de 2\%, todos os
experimentos tinham o tamanho da amostra suficiente. Com precisão de 1\%, apenas
os experimentos para \emph{lt\_rec}, localidade de 50\% e latência de rede 300
ms não tinham tamanho da amostra suficiente -- para variação de latência de 0\%
o experimento precisaria de 127789 amostras mas tinha 115175, e para variação de
latência 60\% ele precisaria de 83030 mas tinha 76137.

Vale notar que o tamanho da amostra na maioria dos experimentos foi bem maior do
que o necessário. Por exemplo, para \emph{ind1}, localidade de 50\% e latência
de 300 ms, foram observadas 358301 amostras quando apenas 933 seriam
suficientes. Isso significa que os experimentos poderiam ser executados em bem
menos tempo caso o \emph{benchmark} fosse limitado por quantidade de requisições
em vez de tempo\footnote{A limitação da quantidade de requisições foi
implementada no \emph{benchmark} pois era necessária para a etapa de
aquecimento, mas não foi usada nos experimentos}.

Normalmente, experimentos são replicados para estimar a variabilidade do
fenômeno observado e calcular os erros experimentais. Replicação estatística
costuma ser usada quando mais de um grupo é usado como objeto do estudo. Este
não é o caso deste estudo, já que o objeto do estudo foi sempre o mesmo. Mas
alguma variabilidade poderia ser causada por variação entre os nós usados. Outra
causa seria variação no desempenho na LAN do Grid5000 em diferentes momentos.

Assim, uma replicação do estudo foi feita para estimar a variabilidade dos
experimentos. Isso foi feito calculando-se o coeficiente de variabilidade entre
as duas replicações de cada experimento. A média dos CVs de todos os
experimentos foi 1\% para leituras e 0,8\% para escritas, e o máximo foi 8\%
para leituras e 5\% para escritas.

%% ------------------------------------------------------------------------- %%
\section{Análise dos Tempos de Resposta}
\label{sec:analise_dos_tempos_de_resposta}

A principal métrica usada neste estudo foi o tempo de resposta. Tomou-se o
cuidado de evitar sobrecarregar o sistema, de modo que os tempos de resposta
representassem o comportamento do sistema no estado estacionário. As figuras
desta seção apresentam duas linhas de grade para auxiliar na interpretação: a
linha vertical indica a latência de rede e a horizontal indica a localidade.

Os gráficos das FDAs dos tempos de resposta quando a latência é 0 ms está na
Figura \ref{fig:fda_dos_tempos_de_resposta_para_latencia_de_rede_de_0_ms}. Como
esperado, as requisições se comportam como se fossem locais. Um fato a se notar
é um degrau nos percentis mais altos das leituras em todos os modos. Uma
explicação possível seria algum tipo de sobrecarga no sistema, mas nesse caso
seria esperado ver comportamento semelhante nas escritas.

\begin{figure}[p] \centering

\includegraphics[width=1\textwidth]{ecdf0.png}

\caption{FDAs dos tempos de resposta para latência de rede de 0 ms.}
\label{fig:fda_dos_tempos_de_resposta_para_latencia_de_rede_de_0_ms}
\end{figure}

Os gráficos das FDAs para 100 ms, 200 ms e 300 ms têm a mesma forma, portanto a
opção foi fazer a análise para um deles apenas. O gráfico para latência de rede
de 200 ms está na Figura
\ref{fig:fda_dos_tempos_de_resposta_para_latencia_de_rede_de_200_ms}.

No caso de leituras e localidade de 50\%, apenas \emph{lt\_rec} apresenta
requisições remotas. Uma porção pequena dessas leituras tem tempo de resposta
menor que a latência da rede, o que se explica pela variação da latência de até
60\%.

Para leituras e localidade de 90\%, \emph{lt\_rec} é beneficiado, mas continua
apresentando tempos de resposta mais altos que os outros modos para parte das
requisições. O degrau que aparecia nos gráficos para latência de 0 ms permanece,
mas no caso de \emph{lt\_rec} ele surge próximo do percentil equivalente a
localidade (50 ou 90). Isso sugere que esse é um efeito que sempre acontece com
requisições locais, independente da proporção que representem do total de
requisições.

No caso de escritas e localidade de 50\%, \emph{lt\_rec} apresenta um desempenho
um pouco melhor que \emph{ind2} e \emph{lt\_qqer}. A explicação provável para
isso é o sistema estar menos carregado para esse modo do que os outros, o que
acontece pois as leituras de \emph{lt\_rec} são mais lentas. Esse fato é
comprovado pela vazão dos modos \emph{lt\_rec}, ev2 e \emph{lt\_qqer},
respectivamente, 594, 1072, 941 operações/s.

Para escritas e localidade de 90\%, \emph{lt\_rec} e \emph{lt\_qqer} apresentam
melhor desempenho devido à localidade, enquanto \emph{ind2} continua
apresentando o mesmo perfil que para localidade de 50\%.

% grep 0.5,uni,2:1,200,60 res.1/summary.csv | cut -d, -f1,11

\begin{figure}[p] \centering

\includegraphics[width=1\textwidth]{ecdf200.png}

\caption{FDAs dos tempos de resposta para latência de rede de 200 ms.}
\label{fig:fda_dos_tempos_de_resposta_para_latencia_de_rede_de_200_ms}
\end{figure}

Uma investigação dos degraus que apareceram nos gráficos para leituras mostra
que em torno do percentil 90 o tempo de resposta aumenta em 10 vezes -- por
exemplo, para \emph{ind1}, localidade de 50\% e latência de 0 ms, o percentil 91
é 3,8 ms e o percentil 92 é 38,0 ms. A partir daí, os tempos de resposta crescem
linearmente, como pode ser visto na
Figura~\ref{fig:aproximacao_da_fda_dos_tempos_de_resposta_para_latencia_de_rede_de_0_ms}.

\begin{figure}[!t] \centering

\includegraphics[width=0.5\textwidth]{ecdf_zoom.png}

\caption{Aproximação da FDA dos tempos de resposta para latência de rede de 0
ms.}
\label{fig:aproximacao_da_fda_dos_tempos_de_resposta_para_latencia_de_rede_de_0_ms}
\end{figure}

Os ganhos e perdas relativos para requisições remotas da consistência na linha
do tempo com relação à consistência em momento indeterminado com $W = 2$ e
latência de rede de 200 ms se encontram na
Tabela~\ref{tab:ganhos_e_perdas_relativos_das_requisicoes_remotas}.

\begin{table}[!h] \begin{center} \begin{tabular}{|c|c|c|c|} \hline

Percentil & Localidade (\%) & \emph{lt\_qqer} & \emph{lt\_rec}\\ \hline

75 & 50 & -15\% & 0,3\% \\ \hline

75 & 90 & 99\% & 99\% \\ \hline

95 & 50 & -28\% & 26\% \\ \hline

95 & 90 & 27\% & 39\% \\ \hline

\end{tabular} \caption[Ganhos e perdas relativos entre modos.]{Ganhos e perdas
relativos dos tempos de resposta para os modos \emph{lt\_qqer} e lt\_lat com
relação a \emph{ind2} para latência de 200 ms. As perdas são indicadas pelo
sinal negativo} \label{tab:ganhos_e_perdas_relativos_das_requisicoes_remotas}
\end{center} \end{table}

Com relação ao percentil 75 e localidade de 50\%, os ganhos são tão altos pois
as requisições são locais para \emph{lt\_qqer} e \emph{lt\_rec} e são remotas
para \emph{ind2}.

Com exceção dos degraus que aparecem nos gráficos para leituras, todos os modos
apresentaram o comportamento esperado. A hipótese de que a consistência na linha
do tempo é competitiva em termos de desempenho com a consistência em momento
indeterminado se confirma para o caso em que a localidade é alta e
principalmente caso leituras de ``qualquer versão'' sejam usadas.

%% ------------------------------------------------------------------------- %%
\section{Análise dos Conflitos} \label{sec:analise_dos_conflitos}

A análise dos conflitos indicou uma proporção muito alta de conflitos, da ordem
de 30\%, para todos os casos com latência diferente de 0 ms e variação de
latência de 60\%. Para variação de latência de 0\%, os conflitos são da ordem de
0,1\%.

Esses números resultam da forma como conflitos são contabilizados no Riak.
Sempre que uma leitura é feita, ela é enviada para todas as réplicas do objeto
requerido. Mesmo após ter retornado uma resposta para o cliente, o coordenador
espera as outras leituras para checar se houve conflito -- e no caso da
consistência em momento indeterminado acionar o mecanismo de resolução de
conflitos. Durante os experimentos o mesmo mecanismo foi mantido na consistência
na linha do tempo para a contagem de conflitos, mas sem acionar a resolução de
conflitos.

No caso em que a latência é 0 ms, as respostas das réplicas para o coordenador
chegam em instantes muito próximos. Já quando existe latência, as réplicas no
mesmo centro de processamento de dados respondem rapidamente, enquanto as
remotas demoram centenas de milissegundos. Quando não há variação de latência,
duas requisições saindo de um CPD chegam no outro CPD na ordem em que foram
emitidas. Mas quando há variação da latência, é possível que a segunda chegue
antes da primeira.

O \emph{benchmark} emite uma leitura antes de toda escrita (ver
Subseção~\ref{sec:fatores_de_carga_de_trabalho}). Considerando que o tempo de
requisições locais é sempre muito baixo, algumas escritas emitidas pelo
\emph{benchmark} chegam ao outro centro de dados antes da leitura -- o tempo de
uma requisição local é de 2 a 4 ms, e o tempo de uma requisição remota com
latência de rede de 100 ms, por exemplo, varia de 100 a 160 ms. No caso em que a
escrita chega antes da leitura, a leitura retorna o valor que acabou de ser
escrito para o coordenador, que por sua vez identifica o conflito. 

Estudos foram feitos com outros valores de variação de latência de 5\%, 15\%,
30\% e 45\%, e com exceção da variação de 5\%, que apresentou 17\% de conflitos,
todos apresentaram valores de conflitos acima de 30\%.

Esse comportamento é um problema para a consistência em momento indeterminado em
uma WAN, pois ela muitas vezes ela vai acionar o mecanismo de resolução de
conflitos desnecessariamente, resultando em duas escritas consecutivas na
réplica remota.

Apesar de as proporções de conflitos serem semelhantes para os dois modelos de
consistência, não se pode dizer que a hipótese foi confirmada. A hipótese
considerava que os conflitos seriam resultado da carga de trabalho, e não do
fato de que toda escrita é precedida de uma leitura.

%% ------------------------------------------------------------------------- %%
\section{Análise das Migrações} \label{sec:analise_das_migracoes}

A análise de migrações foi bastante simples, apenas confirmando o comportamento
observado no aquecimento (ver Subseção~\ref{sec:aquecimento}). As migrações para
consistência na linha do tempo para localidade de 50\% são todas da ordem de
7,1\% do total de requisições, enquanto para localidade de 90\% são de 0,18\%.

%% ------------------------------------------------------------------------- %%
\section{Ameaças à Validade} \label{sec:ameacas_a_validade}

Muitos parâmetros foram fixados e fatores tidos como influentes foram
desconsiderados (ver Capítulo~\ref{cap:parametros_e_fatores}). Com isso, estudos
que usem outros valores para os parâmetros ou considerem outros fatores podem
apresentar resultados diferentes, particularmente a quantidade de nós do
sistema, que apareceu com influência relativamente alta (ver
Subseção~\ref{sec:fatores_de_tamanho_do_sistema_e_benchmark}). Além disso, um
estudo é limitado pelos níveis usados \cite{Jain1991}.  Por exemplo, um estudo
2\textsuperscript{k} havia mostrado influência alta da perda de pacotes usando
1\% como nível (ver Subseção~\ref{sec:fatores_de_rede}).  Com isso, este estudo
provavelmente apresentaria resultados diferentes caso fosse feito com taxas de
perda de pacotes nesse nível.

Os experimentos consideram que todos os nós sempre operam sem falhas (ver
Subseçao~\ref{sec:metas_do_estudo}). Os resultados de experimentos com o sistema
operando em algum modo de falha (desde a falha de um nó até de um centro de
processamento de dados inteiro) devem ser diferentes dos obtidos nesse estudo.
Observação semelhante vale para a carga do sistema.

O Riak usa uma arquitetura muito semelhante à descrita no artigo sobre o Dynamo.
Com isso, os modelos de consistência usados nos experimentos podem apresentar
resultados diferentes em sistemas que usem outras arquiteturas, embora o
desempenho analisado neste estudo foi mais afetado for fatores de rede e carga
de trabalho.

%% ------------------------------------------------------------------------- %%
\section{Trabalhos relacionados} \label{sec:trabalhos_relacionados}

Uma abordagem comum na literatura de sistemas distribuídos é a proposta de um
novo conceito e a implementação de um sistema que use esse conceito seguida de
uma análise de seu desempenho. Tanto o artigo sobre o Dynamo \cite{DeCandia2007}
quanto o sobre o PNUTS \cite{Cooper2008} apresentam análises de desempenho,
sendo que apenas o segundo faz uma análise baseada na carga de trabalho. Há uma
segunda publicação com experimentos com o PNUTS que analisa o consumo de banda
de diferentes políticas de replicação em uma WAN \cite{Kadambi2011}.

Muitos trabalhos apresentam análises de desempenho de sistemas de armazenamento
que usam replicação sobre WANs. Na maior parte dos casos, o objetivo desses
sistemas é provar outros conceitos além da eficiência do modelo de consistência
escolhido por eles. O COPS usa consistência causal+, que é semelhante à
consistência causal com algumas garantia a mais, e implementa transações
\cite{Lloyd2011}. O Scatter propõe uma arquitetura ao mesmo tempo escalável e
com consistência forte \cite{Glendenning2011}. O Zeno usa consistência em
momento indeterminado e é tolerante a falhas bizantinas\footnote{Falhas
bizantinas fazem com que o sistema falhe de uma forma diferente que apenas parar
de responder requisições. O envio de respostas com valores errados para os
clientes é um exemplo de falha bizantina.} \cite{Singh2009}. O Windows Azure
provê um sistema de armazenamento na nuvem com consistência forte
\cite{Calder2011}. O Megastore usa Paxos para implementar consistência forte
\cite{Baker2011}. Nenhum desses trabalhos apresenta comparações com outros
sistemas ou com outros modelos de consistência. Como eles não usam uma aplicação
para execução de testes ou ambiente comum, é difícil fazer qualquer comparação a
partir desses trabalhos.

Beyer et al. realizaram testes para analisar a relação entre as diferentes
configurações de consistência no Cassandra e sua disponibilidade e desempenho
\cite{Beyer2011}. Como esperado, eles notam que configurações que oferecem
consistência mais rígida apresentam pior desempenho.  Renesse e Schneider
apresentam resultados experimentais comparando desempenho e disponibilidade de
replicação mestre-escravo e replicação em cadeia, cada uma delas usando
consistência forte e consistência em momento indeterminado
\cite{VanRenesse2004}. Nenhum desses dois experimentos leva em consideração
operação sobre WAN nem diferentes cargas de trabalho. Yu e Vahdat realizaram uma
análise sobre a relação entre disponibilidade e níveis de consistência em
sistemas replicados em WANs \cite{Yu2001}. Eles comparam a disponibilidade de um
sistema usando consistência forte e consistência contínua, usando diferentes
protocolos de consistência como cópia primária e votação, por exemplo. Esse
trabalho não testa consistência em momento indeterminado nem consistência na
linha do tempo e não observa o desempenho dos modelos de consistência
analisados.

Uma publicação com uma proposta mais próxima da deste trabalho é a comparação
feita entre Cassandra, HBase, PNUTS e MySQL particionado horizontalmente usando
diferentes cargas de trabalho \cite{Cooper2010}. Os resultados servem como uma
comparação entre esses sistemas, mas dizem menos sobre seus modelos de
consistência, dado que os sistemas apresentam arquiteturas e configurações
diferentes. Além disso, os testes são feitos em uma rede local, não em uma WAN.
