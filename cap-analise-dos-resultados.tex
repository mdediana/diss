%% ------------------------------------------------------------------------- %%
\chapter{Análise dos Resultados} \label{cap:analise_dos_resultados}

O estudo final foi um estudo fatorial completo (seção
\ref{sec:tipos_de_experimentos}). A sua execução foi rápida e
usou poucos recursos devido aos estudos fatoriais fracionados feitos para
triagem dos fatores -- a execução de uma repetição do estudo final demorava 6,5 horas. O estudo final usou os fatores e níveis descritos na Tabela
\ref{tab:fatores_e_niveis_do_estudo_final}, em um total de 64 experimentos.

\begin{table}[!h] \begin{center} \begin{tabular}{|l|c|c|} \hline

\multicolumn{1}{|c|}{Fator} & \multicolumn{1}{|c|}{Níveis} &
\multicolumn{1}{|c|}{Total de níveis}\\ \hline

Modo & \emph{ind1}, \emph{ind2}, \emph{lt\_qqer} e \emph{lt\_rec} & 4\\ \hline

Latência da WAN (ms) & 0, 100, 200 e 300 & 4\\ \hline

Variação da latência da WAN (\%) & 0 e 60 & 2\\ \hline

Localidade & 0,5 e 0,9 & 2\\ \hline

\end{tabular}

\caption{Fatores e níveis do estudo final.}
\label{tab:fatores_e_niveis_do_estudo_final}

\end{center} \end{table}

O pequeno número de fatores e níveis foi importante para uma análise consistente
dos resultados. Esse fato é enfatizado pela principal referência metodológica usada
neste trabalho \cite{Jain1991} e também foi sugerido para o autor em
conversa com o pesquisador visitante no IME Jean-Marc Vincent, que possui grande
experiência em estudos de desempenho.

TODO: seções

%% ------------------------------------------------------------------------- %%
\section{Descrição dos Experimentos} \label{sec:descricao_dos_experimentos}

%% ------------------------------------------------------------------------- %%
\subsection{Hipóteses} \label{sec:hipoteses}

A principal hipótese deste trabalho era que um sistema georeplicado usando consistência na
linha do tempo apresentaria um desempenho competitivo com a consistência em
momento indeterminado para algumas cargas de trabalho, como uma que apresentasse
localidade alta, por exemplo. Essa hipótese se baseava em uma
segunda hipótese, a de que os tempos de resposta das requisições para o sistema
seriam dominadas pela latência (e variação da latência) da WAN. Um exemplo de fenômeno
que poderia invalidar a hipótese seria a réplica mestre se comportar como
gargalo na consistência na linha do tempo. Essa hipótese é verificada pela
distribuição acumulada dos tempos de resposta para cada modo usado no estudo.

Outra hipótese é que as proporções de conflitos identificados durante as
leituras em ambos os
modelos de consistência seriam próximas. Conflitos na consistência na linha do tempo aparecem pois
atualizações são enfileiradas na réplica mestre. Existe um intervalo de tempo em
que a atualização foi aplicada na réplica mestre mas ainda não foi enviada para
as outras réplicas, esse intervalo é a janela de inconsistência. A
consistência em momento indeterminado apresenta conflitos por motivo semelhante,
com a diferença que a atualização pode ser aplicada em qualquer réplica. Uma
segunda diferença relacionada a esse fato é que ela permite atualizações
simultâneas e divergentes, o que não é permitido pela consistência na linha do
tempo. Assim, os conflitos no caso da consitência em momento indeterminado são
mais graves.

%% ------------------------------------------------------------------------- %%
\subsection{Tamanho das amostras e replicações} \label{sec:}

%O tratamento estatístico dado para os experimentos consistiu basicamente na
%definição do tempo de execução de cada experimento de forma a ter amostras
%suficientes para garantir o nível de confiabilidade procurado.
%
%A quantidade de amostras necessárias é dada por:
%
%$n = (\frac{100 * z * s}{r * \bar{x}})^2$,
%
%onde z é o valor z relativo do nível de confiança desejado, s é o desvio padrão amostral, r é a
%precisão desejada e $\bar{x}$ é a média.
%
%Para fazer a estimativa, foi usado o experimento com maior desvio padrão, que é
%aquele em que a quantidade de requisições locais e remotas é balanceada
%e a variação da rede é a maior. Esse experimento é o que tem modo \emph{lt\_rec} e
%localidade 50\%, latência de rede 300 ms e variação da latência de 60\%. O
%cálculo foi feito considerando o nível de confiança de 95\% ($z = 1.960$) e
%precisão de 1\%. A principal referência metodológica usada para o estudo
%considera níveis de confiança de 90\% ou 95\% altos \cite{Jain1991}. Os valores da média e desvio padrão foram calculados a partir
%dos percentis e eram em $\bar{x} = 0,2533949$ s e $s = 0,2878649$ s.
%
%A partir desses valores a quantidade de amostras necessárias é 49579. Esse experimento sendo executado ao longo de 3 min resultou em um total de 50828
%amostras, e é o experimento com menor número de amostras do estudo. Como a
%configuração padrão do \emph{benchmark} era baseada em tempo e não em quantidade de
%requisições, os experimentos usaram 3 min como tempo. Vale notar que o nível de confiança
%de 95\% é o mínimo atingido, os outros experimentos adquiriram  mais amostras e portanto oferecem uma confiança maior que os 95\%.
%
%min=1000000; for f in res.1/*/summary.csv; do n=$(tail -1 $f | cut -d, -f3);
%echo $n; [[ $min -gt $n ]] && min=$n; done; echo $min

%% ------------------------------------------------------------------------- %%
\section{Análise dos Tempos de Resposta}
\label{sec:analise_dos_tempos_de_resposta}

A principal métrica usada neste estudo foi o tempo de resposta. Tomou-se o
cuidado de evitar sobrecarregar o sistema, de forma que os tempos de resposta
representassem o comportamento do sistema no estado estacionário. Todas as
figuras desta seção apresentam duas linhas de grade para auxiliar na
interpretação: a linha vertical indica a latência de rede e a horizontal indica a localidade.

Os gráficos das FDAs dos tempos de resposta quando a latência é 0 ms está na
Figura \ref{fig:fda_dos_tempos_de_resposta_para_latencia_de_rede_de_0_ms} Como
esperado, todas as requisições se comportam como se fossem locais. Um fato a se
notar é um degrau nos percentis mais altos das leituras em todos os modos. Uma
explicação possível seria algum tipo de sobrecarga no sistema, mas nesse caso
seria esperado ver comportamento semelhante nas escritas.

\begin{figure}[p] \centering

\includegraphics[width=1\textwidth]{ecdf0.png}

\caption{FDAs dos tempos de resposta para latência de rede de 0 ms.}
\label{fig:fda_dos_tempos_de_resposta_para_latencia_de_rede_de_0_ms}
\end{figure}

Os gráficos das FDAs para 100 ms, 200 ms e 300 ms têm a mesma forma, portanto a
opção foi fazer a análise do valor intermediário. O gráfico para latência de
rede de 200 ms pode ser visto na Figura
\ref{fig:fda_dos_tempos_de_resposta_para_latencia_de_rede_de_200_ms}.

No caso de leituras e localidade 50\%, apenas \emph{lt\_rec} apresenta requisições
remotas. Uma porção pequena dessas leituras tem tempo de resposta menor que a
latência da rede, o que se explica pela variação da latência de até 60\%. A
localidade 90\% beneficia \emph{lt\_rec}, que continua
apresentando tempos de resposta mais altos que os outros modos. O degrau que
aparecia nos gráficos para latência de 0 ms permanece, mas no caso de \emph{lt\_rec} ele
surge próximo do percentil equivalente a localidade (50 ou 90). Isso sugere que esse e um
efeito que sempre afeta requisições locais, independente da proporção que
representem do total de requisições.

No caso de escritas e localidade 50\%, \emph{lt\_rec} apresenta um desempenho um pouco
melhor que ev2 e \emph{lt\_qqer}. A explicação provável para isso é o fato de o sistema
estar menos carregado para esse modo do que os outros, o que acontece pois as leituras de \emph{lt\_rec} são mais lentas. Esse fato pode ser
comprovado pela vazão dos modos \emph{lt\_rec}, ev2 e \emph{lt\_qqer}, respectivamente, 594,
1072, 941 operações/s. Já no caso de localidade 0,9, \emph{lt\_rec} e \emph{lt\_qqer} se
beneficiam da localidade, enquanto ev2 não e continua com o mesmo perfil
apresentado para localidade 0,5.

% grep 0.5,uni,2:1,200,60 res.1/summary.csv | cut -d, -f1,11

\begin{figure}[p] \centering

\includegraphics[width=1\textwidth]{ecdf200.png}

\caption{FDAs dos tempos de resposta para latência de rede de 200 ms.}
\label{fig:fda_dos_tempos_de_resposta_para_latencia_de_rede_de_200_ms}
\end{figure}

Com exceção dos degraus que aparecem nos gráficos, todos os modos apresentaram
o comportamento esperado.

%% ------------------------------------------------------------------------- %%
\section{Análise dos Conflitos} \label{sec:analise_dos_conflitos}

A análise dos conflitos

%% ------------------------------------------------------------------------- %%
\section{Análise das Migrações} \label{sec:analise_das_migracoes}

%% ------------------------------------------------------------------------- %%
%\section{TEXTO DA QUALIFICAÇÃO - DESCARTAR?} \subsection{Resultados parciais}
%\label{sec:resultados_parciais}
%
%Até o momento foram executados alguns testes para um melhor entendimento do
%problema sendo tratado e para o estudo e a avaliação das tecnologias usadas nos
%experimentos.
%
%Primeiramente foram executados alguns experimentos no Revoada, aglomerado de 8
%nós administrado pelo IME - USP. Esses experimentos usaram o Cassandra
%\cite{Lakshman2010} como sistema de armazenamento e YCSB \cite{Cooper2010} como
%aplicação para execução dos testes, e foram feitos como testes preliminares
%sobre o efeito da latência de rede no desempenho de diferentes níveis de
%consistência. Os experimentos usaram 3 nós de Cassandra e uma instância do
%YCSB.  Foram usados os níveis de consistência ONE ($W = 1$ ou $R = 1$), QUORUM
%($W = \lceil(N+1)/2\rceil$ ou $R = \lceil(N+1)/2\rceil)$ e ALL ($W = N$ ou $R =
%N$) e latências variando de 0 a 300 ms. O YCSB não estava preparado para lidar
%com diferentes configurações de consistência do Cassandra e foi alterado para
%tal.  Para uma dada latência de rede, foi observado um aumento no tempo de
%resposta e diminuição da vazão a medida em que configurações mais rígidas de
%consistência foram usadas. Para uma dada configuração de consistência, foi
%observado um aumento no tempo de resposta e diminuição da vazão a medida em que
%a latência de rede foi aumentada. A preparação e execução desses experimentos
%colaborou para um melhor entendimento de ferramentas e técnicas a serem usadas
%neste trabalho.
%
%Um segundo conjunto de experimentos foi realizado no Grid5000 com três
%configurações de consistência implementadas no Riak \cite{Riak}: consistência
%em momento indeterminado, consistência na linha do tempo com leituras
%consistentes e consistência na linha do tempo com leituras de qualquer versão.
%Os experimentos usaram um aglomerado de 6 nós para o Riak, e um nó para o Basho
%Bench \cite{Basho}. Os experimentos foram feitos usando latências de 0 a 150
%ms.  Foram usadas 3 configurações relativas à distribuição dos nós por centros
%de dados: todos os nós no mesmo centro de dados, dois nós em um centro de dados
%remoto e quatro nós em um centro de dados remoto (o centro de dados local é o
%centro de dados onde a aplicação de execução de testes roda). A carga de
%trabalho usada foi uniforme para distribuição das chaves e para alvos dos
%acessos. Esses experimentos funcionaram como testes da implementação de
%consistência na linha do tempo. Os resultados observados não foram os
%esperados, pois indicaram um melhor desempenho da consistência em momento
%indeterminado, seguido da consistência na linha do tempo com leituras
%consistentes e por último consistência na linha do tempo com leituras de versão
%qualquer. O resultado esperado seria que leituras de versão qualquer
%apresentassem desempenho melhor do que leituras consistentes. Isso pode ter
%acontecido por problemas na implementação ou por algum fator não previsto no
%funcionamento desses modelos de consistência. Esse fato precisa ser
%investigado. Além disso, como esperado, os experimentos mostraram a existência
%de conflitos na consistência em momento indeterminado, enquanto nenhum conflito
%aconteceu na consistência na linha do tempo. O impacto desses conflitos no
%desempenho não foi medido. A partir desses experimentos foi possível entender o
%comportamento do Riak no ambiente do Grid5000, além de servir como prova de
%conceito da implementação da consistência na linha do tempo no Riak.
%
%%% ------------------------------------------------------------------------- %%
%\subsection{Apresentação dos resultados}
%\label{sec:apresentacao_dos_resultados}
%
%\textbf{TEXTO DA QUALIFICAÇÃO}
%
%A comparação de desempenho dos dois modelos de consistência será apresentada em
%duas tabelas, uma para os valores obtidos de tempo de resposta e outra para
%vazão. Cada linha corresponde a uma carga de trabalho, dada pela tripla
%(distribuição de operações, distribuição dos destinos dos acessos, localidade).
%Cada latência da rede define uma coluna. Cada célula da tabela apresenta 3
%valores: o desempenho da consistência em momento indeterminado, consistência na
%linha do tempo com leitura mais recente e consistência na linha do tempo com
%leitura qualquer.
%
%Outros valores e gráficos que ajudem na interpretação dos resultados serão
%apresentados, como a quantidade de conflitos no caso da consistência em momento
%indeterminado.

%% ------------------------------------------------------------------------- %%
\section{Ameaças à Validade} \label{sec:ameacas_a_validade}

O Riak usa uma arquitetura muito semelhante à descrita no artigo sobre o Dynamo.
Com isso, os modelos de consistência usados nos experimentos podem apresentar
outros resultados em sistemas que usem outras arquiteturas, embora o desempenho
analisado neste estudo foi mais afetado for fatores de rede e carga de trabalho.

Por limitação de tempo e recursos algumas variáveis que podem alterar os
resultados desse trabalho foram desconsideradas ou fixadas. Esse é o caso de
todas as variáveis de controle e constantes, que poderiam ser trabalhadas como
variáveis independentes. Com isso, os resultados dos experimentos podem ser
diferentes caso sejam usados, por exemplo, um fator de replicação ou uma
quantidade de centros de dados diferentes. Em particular, testes de
escalabilidade serão realizados para entender a influência do tamanho do sistema
nos resultados.

Os experimentos consideram que todos os nós sempre operam sem falhas. Os
resultados de experimentos com o sistema operando em algum modo de falha (desde
a falha de um nó até de um centro de dados inteiro) devem ser diferentes dos
btidos nesse estudo.
