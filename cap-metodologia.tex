%% ------------------------------------------------------------------------- %%
\chapter{Metodologia} \label{cap:metodologia}

Este trabalho consiste na comparação do desempenho da consistência em momento
indeterminado e da consistência na linha do tempo em um sistema de armazenamento
distribuído operando sobre uma WAN. Para essa análise, o método proposto por
Jain em \cite{Jain1991} é usado. O método consiste em 10 passos:

% Jain - pag 37
\begin{enumerate} \item Declaração das metas e definição do sistema \item Lista
de serviços do sistema e seus resultados \item Seleção de métricas \item Lista
de parâmetros \item Seleção de fatores a serem estudados \item Seleção da
técnica de avaliação \item Seleção da carga de trabalho \item Projeto dos
experimentos \item Análise e interpretação dos dados \item Apresentação dos
resultados \end{enumerate}

Métricas são os critérios usados para a comparação de desempenho, como vazão e
tempo de resposta (variáveis dependentes). Parâmetros são todas as
características do sistema, do ambiente de operação e da carga de trabalho que
podem influenciar o desempenho do sistema, como a CPU ou a latência da rede.
Fatores são os parâmetros que são variados nos experimentos (variáveis
independentes). Além dos fatores, a interação entre fatores também pode afetar o
desempenho. A ordem de uma interação entre fatores é a quantidade de fatores
envolvidos na interação (por exemplo, uma interação de segunda ordem é a
interação entre dois fatores). Os valores dos fatores nos experimentos são os
níveis. Os parâmetros que não são fatores possuem um único valor em todos os
experimentos (variáveis fixas e constantes).

Os passos 1 a 7 são tratados neste capítulo. O passo 8 está no capítulo
\ref{cap:projeto_dos_experimentos} e os passos 9 e 10 estão no capítulo
\ref{cap:analise_dos_resultados}.

%% ------------------------------------------------------------------------- %%
\section{Declaração das metas e definição do sistema}
\label{sec:declaracao_das_metas_e_definicao_do_sistema}

O objetivo deste estudo é comparar o desempenho da consistência em momento
indeterminado com o da consistência na linha do tempo em um sistema de
armazenamento distribuído geo-replicado. Essa situação é modelada como um único
sistema distribuído entre dois centros de dados ligados por uma WAN. Nesse
cenário, uma requisição local é aquela atendida no mesmo centro de dados em que
chega e possui baixo tempo de resposta (da ordem de poucos milissegundos). Já
uma requisição remota é aquela que chega em um centro de dados e é encaminhada
para ser atendida em outro e normalmente possui tempo de resposta alto (da ordem
de dezenas ou centenas de milissegundos). O modelo usado neste estudo
possibilita diferentes combinações entre requisições locais e remotas dependendo
do modelo de consistência usado e da sua configuração (ver \ref{sec:modo}).

% Definição do TCP, no summary do TCP em Stevens.
Para entender a dinâmica do sistema geo-replicado é necessário entender as
características da rede sobre a qual ele opera. Esse estudo considera um sistema
operando sobre TCP/IP, pilha de protocolos comumente utilizada nesses sistemas.
O protocolo IP provê os mecanismos de endereçamento e roteamento. O protocolo
TCP provê conexão ponto-a-ponto confiável, reconhecendo os dados recebidos,
enviando-os novamente caso o reconhecimento não seja recebido dentro de um
determinado período de tempo, reordenando pacotes recebidos fora de ordem,
descartando pacotes duplicados, verificando pacotes corrompidos e provendo
controle de fluxo.

Um estudo completo consideraria atributos de qualidade do sistema além de
desempenho, como disponibilidade e manutenibilidade, mas que não são
considerados neste estudo por limitações de escopo e recursos. Estudos futuros
podem contemplar esses e outros atributos de qualidade.

O sistema usado como alvo do estudo é uma versão modificada do Riak, uma tabela
de espalhamento distribuída \cite{Riak} (detalhes sobre a escolha e a
implementação estão na seção \ref{sec:sistema_de_armazenamento}). Como o
objetivo deste estudo é comparar os dois modelos de consistência e não sistemas
que os implementem, os experimentos foram planejados e executados de forma a
isolar tanto quanto possível questões específicas do sistema.

%% ------------------------------------------------------------------------- %%
\section{Lista de serviços do sistema e seus resultados}
\label{sec:lista_de_servicos_do_sistema_e_seus_resultados}

O sistema de armazenamento usado é uma tabela de espalhamento distribuída.
Assim, o principal serviço oferecido pelo sistema são operações CRUD sobre pares
chave-valor. O segundo serviço fundamental para este estudo é a replicação dos
objetos armazenados.

Para consistência em momento indeterminado, a replicação é parametrizada a
partir dos valores N, R e W (seção \ref{sec:replicacao_otimista}). Requisições
dos clientes podem chegar a qualquer nó do sistema. Caso a requisição seja uma
leitura, esse nó é o coordenador e envia requisições de leitura para os nós que
contêm réplicas do objeto requerido. Caso a requisição seja uma escrita e esse
nó seja responsável por alguma das réplicas, ele é o coordenador e atende a
requisição, caso contrário ele encaminha a requisição para um dos nós que contém
uma réplica do objeto, que será o coordenador. A partir disso, uma requisição
pode apresentar os seguintes resultados:

\begin{itemize} \item Bem sucedida: Se ao menos R réplicas responderem para o
coordenador caso a requisição seja uma leitura, ou se ao menos W réplicas
confirmarem para o coordenador que o objeto foi armazenado, modificado ou
removido caso a requisição seja uma escrita.  \item Falha: Se menos do que R
réplicas para leitura ou W réplicas para escrita responderem para o coordenador
dentro de um determinado intervalo de tempo (timeout de servidor).  \item
Timeout: Se o cliente desistir de esperar uma resposta após um determinado
período de tempo (timeout de cliente).  \end{itemize}

Para consistência na linha do tempo, a replicação é parametrizada apenas pelo
valor N. Requisições dos clientes podem chegar a qualquer nó do sistema.  Caso a
requisição seja uma leitura de ``qualquer versão'', esse nó é o coordenador e
envia requisições de leitura para os nós que contêm réplicas do objeto requerido
e assim que recebe a primeira resposta retorna para o cliente. Caso a requisição
seja uma leitura da ``versão mais recente'' e o nó seja o mestre para o objeto
requerido, ele é o coordenador e atende a requisição, caso contrário ele
encaminha a requisição para o mestre que será o coordenador. O sistema se
comporta da mesma maneira que leituras de ``versão mais recente'' para
escritas.A partir disso, uma requisição pode apresentar os seguintes resultados:

\begin{itemize} \item Bem sucedida: Se ao menos uma réplica responder para o
coordenador no caso de leitura de ``qualquer versão'', se o mestre responder no
caso de leitura de ``versão mais recente'' ou se o mestre confirmar que o objeto
foi armazenado, modificado ou removido no caso de escrita.  \item Falha: Se
nenhuma réplica responder para o coordenador dentro de um determinado intervalo
de tempo no caso de leitura de ``qualquer versão''. Se o mestre não responder
dentro de um determinado intervalo de tempo (timeout de servidor) no caso de
escrita ou leitura de ``versão mais recente''.  \item Timeout: Se o cliente
desistir de esperar uma resposta após um determinado período de tempo (timeout
de cliente).  \end{itemize}

%% ------------------------------------------------------------------------- %%
\section{Seleção de métricas} \label{sec:selecao_de_metricas}

A principal métrica usada como base de comparação do desempenho dos modelos de
consistência é o tempo de resposta das requisições (medido em s).  Quanto menor
o tempo de resposta, melhor o desempenho de um modelo de consistência. Como
existem requisições locais e remotas com tempos de resposta bem diferentes, essa
métrica não deve ser analisada como uma média, mas sim através de percentis.

Além do tempo de resposta, outras métricas observadas foram vazão (em
operações/s), quantidade de migrações e conflitos (ambas dadas pela porcentagem
com relação ao total de operações do experimento). Vazão não é considerada uma
meta principal pois os clientes apresentam uma taxa de requisição fixada nos
experimentos, de forma a diminuir possíveis influências de sobrecarga do
sistema. A quantidade de migrações, exclusiva da consistência na linha do tempo,
oferece uma visão da dinâmica de um sistema que use esse modelo de consistência.
A quantidade de conflitos proporciona uma noção da frequência com que cliente
leem valores desatualizados. Uma diferença entre conflitos nos dois tipos de
consistência é que na linha do tempo eles são causados apenas por atualizações
que ainda não chegaram a todas as réplicas, portanto serão automaticamente
resolvidos. Já na consistência em momento indeterminado, eles podem ser mais
graves, dado que esse modelo permite atualizações divergentes.

%% ------------------------------------------------------------------------- %%
\section{Lista de parâmetros} \label{sec:lista_de_parametros}

Os parâmetros que afetam o desempenho do sistema podem ser divididos em três
categorias: parâmetros de sistema, de rede e de carga de trabalho.

Os principais parâmetros de sistema que podem afetar seu desempenho são:
  
% Chequei app.config e vm/args
%TODO: falar de ring_size no alg de particionamento
\begin{itemize} \item CPU local e CPU remota \item Quantidade de memória local e
remota \item Banda disponível local e remota \item Mecanismo de armazenamento --
memória ou disco \item Desempenhos de acesso sequencial de leitura e de escrita
do disco (para disco como mecanismo de armazenamento) \item Desempenhos de
acesso aleatório de leitura e de escrita do disco (para disco como mecanismo de
armazenamento) \item Quantidade de nós do sistema \item Quantidade de objetos
armazenados \item Tamanho dos objetos armazenados \item Quantidade de centros de
dados \item Quantidade de nós por centro de dados

\item Algoritmo de particionamento das chaves \item Algoritmo de detecção de
falhas \item Fator de replicação ($N$) \item Configuração de replicação -- $R$ e
$W$ (para consistência em momento indeterminado) \item Limiar de migração (para
consistência na linha do tempo) \item Interface de acesso \item Nível de log
\end{itemize}

Os principais parâmetros de rede que podem afetar o desempenho do sistema são:

\begin{itemize} \item Topologia da rede \item Largura de banda dos elementos de
rede intermediários (switches, roteadores, etc) \item Latência da LAN \item
Latência da WAN \item Variação da latência da WAN \item Taxa de perda de pacotes
da WAN \item Taxa de duplicação de pacotes da WAN \item Taxa de corrupção de
pacotes da WAN \item Proporção de pacotes fora de ordem na WAN \item Algoritmo
de congestionamento \item Relação entre largura de banda e latência (Produto
Banda-Latência, \emph{Bandwidth Delay Product} -- BDP) \end{itemize}

Variação da latência, taxas de perda, de duplicação e de corrupção de pacotes e
proporção de pacotes fora de ordem não são considerados para LAN pois ocorrem
com menor frequência e geram pouco impacto nesse tipo de rede. Em WANs, esses
fenômenos estão relacionados a uma maior quantidade de nós intermediários
(incluindo roteadores e proxies) e redes heterogêneas que os pacotes atravessam.

Os principais parâmetros da carga de trabalho que podem afetar o desempenho do
sistema são:

\begin{itemize} \item Distribuição de operações \item Localidade \item
Popularidade dos objetos acessados \item Taxa de chegada de requisições \item
Versão requisitada nas leituras (para consistência na linha do tempo)
\end{itemize}

A subseção seguinte discute os fatores escolhidos para os experimentos. Os
parâmetros que não são fatores e seus valores estão na seção
\label{sec:parametros_fixados}.

%% ------------------------------------------------------------------------- %%
\section{Seleção de fatores a serem estudados}
\label{sec:selecao_de_fatores_a_serem_estudados}

Os fatores foram escolhidos de forma a aproximar este estudo dos ambientes de
produção de sistemas web geo-replicados, assim fatores que influenciam o
comportamento do sistema operando sobre WAN foram priorizados. Apesar disso,
essa lista não é exaustiva por limitações de recursos e do escopo deste estudo
(ver as ameaças à validade na subseção \ref{sec:ameacas_a_validade}).

Para estudos desse tipo, é comum os experimentos serem realizados em duas
etapas. A primeira, que faz parte do projeto dos experimentos, usa mais fatores
e poucos níveis, e tem por objetivo encontrar os fatores mais influentes e fixar
os restantes como parâmetros. A segunda usa os fatores mais influentes com mais
níveis. Os fatores apresentados nesta seção são os inicialmente selecionados. A
descrição do projeto dos experimentos, dos fatores e seus níveis encontra-se no
capítulo \ref{cap:projeto_dos_experimentos}.
 
Dois fatores que possuem um tratamento especial ao longo do experimento são
configuração de replicação (para consistência em momento indeterminado) e versão
requisitada nas leituras (para consistência na linha do tempo). Isso porque seus
níveis influenciam na proporção de requisições locais e remotas, fundamental
para este estudo. Por isso, esses dois fatores são tratados como um único,
chamado modo (subseção \ref{sec:modo}). Os fatores restantes estão descritos na
seção \ref{sec:fatores_iniciais}.

%% ------------------------------------------------------------------------- %%
\subsection{Modo} \label{sec:modo}

Todas as configurações usam $N = 3$, comumente adotado em aplicações web (ver
subseção \ref{sec:parametros_fixados}). Os níveis dos modos são:

\begin{itemize} \item ind1: Consistência em momento indeterminado com $W$ = 1 e
$R$ = 1 \item ind2: Consistência em momento indeterminado com $W$ = 2 e $R$ = 1
\item lt\_qqer: Consistência na linha do tempo com leituras de qualquer versão
\item lt\_rec: Consistência na linha do tempo com leituras da versão mais
recente \end{itemize}

Os experimentos simulam dois centros de dados e $N = 3$. O algoritmo de
particionamento garante que existe ao menos uma réplica em cada centro de dados
(ver \ref{sec:sistema_de_armazenamento}). Assim, existem sempre duas situações
possíveis com relação à localização das réplicas do ponto de vista do
coordenador: uma local e duas remota ou duas locais e uma remota. Dado isso,
ind1 resulta em todas as leituras e escritas locais.  ind2 resulta em todas as
leituras locais e metade das escritas locais e a outra metade remotas. lt\_qqer
resulta em todas as leituras locais e a quantidade de escritas dependente da
localidade dos acessos. Finalmente, lt\_rec resulta tanto em leituras quanto
escritas dependentes da localidade.

Os modos foram escolhidos de forma a representar situações encontradas em
sistemas de produção e ao mesmo tempo limitar a quantidade de níveis de forma a
tornar os experimentos viáveis devido a limitação de recursos. Assim,
consistência na linha do tempo com leituras de versões específicas não foi
considerada já que ela é um meio termo entre leituras de versão mais recente e
leituras de qualquer versão. Consistência em momento indeterminado com $W = 1$ e
$R = 2$ não foi considerada pois sua semântica é similar a $W = 2$ e $R = 1$,
mas teria seu desempenho prejudicado considerando que leituras predominam nas
distribuições de operações usadas nos experimentos (ver subseção
\ref{sec:distribuicao_de_operacoes}).

Esses modos implicam em trocas além de desempenho e consistência. A principal é
durabilidade, que para ind2 é mais alta do que para os outros casos, em que a
confirmação de escrita de uma única réplica é suficiente.

%% ------------------------------------------------------------------------- %%
\subsection{Fatores iniciais} \label{sec:fatores_iniciais}

Os fatores inicialmente selecionados foram:

\paragraph{Aglomerado}As configurações relativas a hardware (CPU, memória, etc)
estavam limitadas às oferecidas pelo Grid5000 (ver seção \ref{sec:ambiente}).
Cada aglomerado do Grid5000 possui todos os nós com mesma configuração de
hardware. Com isso, decidiu-se restringir os experimentos a um único aglomerado,
de forma a eliminar possíveis influências de heterogeneidade de hardware. Assim,
um estudo foi feito na primeira etapa dos experimentos para a decisão do
aglomerado a ser usado.

\paragraph{Quantidade de nós do sistema}A decisão de usar um único aglomerado
implicou em um tamanho máximo do sistema restrito a quantidade de nós do
aglomerado escolhido.  A forma como se opera no Grid5000 impôs algumas
restrições operacionais. Uma delas são regras que restringem o uso diário da
infraestrutura. Outra é a concorrência por recursos entre os usuários, quanto
menor a quantidade de nós reservada, maiores as chances de se conseguir uma
reserva. Além dessas, uma terceira restrição é devida ao fato de a quantidade de
partições do anel do espalhamento consistente precisar ser uma potência de 2.
Com isso, uma maneira simples para distribuir as partições igualmente entre os
nós é assumir uma quantidade de nós que também fosse potência de 2.

\paragraph{Quantidade de objetos armazenados}A quantidade de objetos armazenados
pode influenciar na quantidade de dados no cache de disco (caso seja esse o
mecanismo de armazenamento utilizado). Além disso, esse fator também pode
influenciar a quantidade de conflitos, já que quanto menos objetos existirem no
banco de dados, maior a chance de um dado objeto receber uma requisição.

\paragraph{Tamanho dos objetos armazenados}O tamanho dos objetos armazenados
pode influenciar na quantidade de dados no cache de disco (caso seja esse o
mecanismo de armazenamento utilizado). No caso de armazenamento em memória, eles
podem causar fragmentação de memória, o que também afeta o desempenho. Além
disso, esse fator pode influenciar no desempenho da rede, dado que objetos muito
grandes podem precisar ser divididos em mais de um pacote TCP e objetos muito
pequenos resultam em uma carga paga relativamente menor.

\paragraph{Latência da WAN}As latências de ida e volta médias usadas nos
experimentos são baseadas nas latências entre os centros de dados dos Amazon Web
Services \cite{Sovran2011}.  Os centros de dados considerados são Califórnia
(EUA -- Costa Oeste), Virginia (EUA -- Costa Leste), Irlanda e Singapura. A
menor latência observada foi 82 ms entre os centros de dados dos EUA e a maior
foi 277 ms entre Irlanda e Singapura.

\paragraph{Variação da latência da WAN}A latência em uma WAN não é constante,
dado que dentre suas causas está a dinâmica da rede. Por exemplo, rajadas de
tráfego podem encher os buffers de um roteador no caminho entre dois nós,
fazendo com que pacotes sejam descartados, o que se manifesta para o transmissor
como um aumento de latência. Além disso, as variações normalmente não são
aleatórias. A partir do mesmo exemplo, enquanto o roteador está sobrecarregado a
latência vista pelo enviador é mais alta, quando ele volta a operar normalmente
a latência vista pelo transmissor passa a ser mais baixa. Por isso, além da
variação existe uma correlação entre os valores de latência observados ao longo
do tempo.
%TODO: citar post do amp sobre variação de latência

\paragraph{Taxa de perda de pacotes da WAN}A perda de pacotes é uma das
principais causas por atrasos e gargalos em um sistema usando TCP, dado que ao
registrar a perda de um pacote a janela de transmissão da conexão é reiniciada,
o que se manifesta como diminuição da banda. Além disso, o mecanismo padrão de
retransmissão do TCP aumenta exponencialmente o tempo entre tentativas, portanto
quanto maior o número de pacotes perdidos, mais tempo demora para os pacotes
serem reenviados.  Considera-se que perdas acima de x\% tornam a comunicação
praticamente impossível.
%TODO: ref sobre perdas

\paragraph{Taxa de duplicação de pacotes da WAN}Pacotes duplicados afetam a
comunicação TCP principalmente por gerarem tráfico desnecessariamente. Fora
isso, geram pouco impacto já que o tratamento dado pelo TCP é o descarte dos
pacotes duplicados no receptor.
%TODO: checar problemas de duplicação

\paragraph{Taxa de pacotes corrompidos da WAN}Pacotes corrompidos afetam a
comunicação TCP por gerarem retransmissões.
%TODO: checar problemas de corrupção

\paragraph{Proporção de pacotes fora de ordem na WAN}Pacotes fora de ordem
afetam a comunicação TCP principalmente por ocuparem buffers em elementos de
rede intermediários e finais no aguardo dos pacotes anteriores a eles.
%TODO: checar problemas de pacotes fora de ordem

\paragraph{Algoritmo de congestionamento}O desempenho da comunicação TCP é
dependente do algoritmo de congestionamento usado. Esse tipo de algoritmo é
responsável pelo dimensionamento da janela de transmissão. Em referências sobre
otimização da pilha TCP para WANs é comum ver dois algoritmos citados.
%TODO: checar como algoritmo de congestionamento realmente opera TODO: refs dos
%algoritmos

\paragraph{Relação entre banda e latência (Produto Banda-Latência -- BDP) }A
quantidade de dados em trânsito em uma conexão TCP é dada pelo Produto
Banda-Latência. Dessa forma, dada uma largura de banda, quanto maior a latência
da rede, maior a quantidade de pacotes em trânsito. Um gargalo comum nesse caso
é o tamanho dos buffers de envio e recepção. Referências sobre otimização da
pilha TCP para WANs sugerem que o tamanho ideal para esses buffers é o dobro do
BDP.

\paragraph{Distribuição de operações}Diferentes distribuições de escrita/leitura
resultam em diferentes desempenhos.  Por exemplo, a consistência na linha do
tempo pode apresentar desempenho mais baixo em um cenário de escrita intensiva,
pois a réplica mestre pode se tornar um gargalo. Além disso, a probabilidade de
haver conflitos entre réplicas aumenta com o aumento da taxa de escritas em um
sistema que usa consistência em momento indeterminado, que pode sofrer um
impacto no seu desempenho devido à execução de seus algoritmos de resolução de
conflitos. Por outro lado, um sistema que usa consistência na linha do tempo não
apresenta esse problema dado que conflitos entre réplicas não são possíveis.

\paragraph{Popularidade dos objetos acessados}Em muitas aplicações a
popularidade dos objetos não é uniforme, alguns são mais acessados do que
outros. Um exemplo é uma loja virtual em que o interesse dos clientes pelos
produtos tende a obedecer uma lei de potência \cite{Anderson2006}. A existência
de objetos muito populares pode prejudicar o desempenho de um modelo de
consistência como a consistência na linha do tempo, em que a réplica mestre pode
se tornar um gargalo nas escritas.

\paragraph{Localidade}Cooper et al. notam um alto índice de localidade nos
acessos aos objetos dos sistemas no Yahoo! \cite{Cooper2008}. Em uma análise
feita no período de uma semana, foi observado que em média 85\% das escritas a
determinado objeto vinham do mesmo centro de dados. Isso acontece por exemplo em
uma rede social, em que os usuários costumam acessar a aplicação a partir da
mesma localização geográfica e possuem a maior parte de seus contatos na mesma
localização geográfica -- usuários brasileiros tendem a acessar o sistema do
Brasil e a maioria de seus contatos é brasileira, por exemplo. Nesse caso, se os
objetos são particionados no sistema a partir da localização geográfica dos
acessos mais recentes é possível economizar um número considerável de
requisições entre centros de dados. A implementação do PNUTS usa esse fato para
implementar uma otimização de desempenho, movendo a réplica mestre para o centro
de dados do qual vieram as últimas 3 escritas do objeto. Essa otimização foi
implementada no sistema de armazenamento usado nos experimentos.

%% ------------------------------------------------------------------------- %%
\section{Seleção da técnica de avaliação}
\label{sec:selecao_da_tecnica_de_avaliacao}

Existem três técnicas comumente usadas na análise de desempenho de sistemas:
simulação, modelagem analítica e medição \cite{Jain1991}. É muito difícil criar
simuladores ou modelos que levem em consideração a interação entre todos os
fatores que afetam o desempenho de um modelo de consistência: as diferentes
cargas de trabalho (incluindo questões de localidade), as características da
rede, os algoritmos de resolução de conflitos, etc. Assim, a adoção de simulação
ou modelagem analítica sacrificaria o realismo e a precisão deste estudo. Daí a
escolha de medição, pela qual é possível analisar o comportamento de um sistema
de armazenamento que represente o resultado da interação de vários dos fatores
que afetam o desempenho de um modelo de consistência.

%% ------------------------------------------------------------------------- %%
\section{Seleção da carga de trabalho} \label{sec:selecao_da_carga_de_trabalho}

Considerando que o tipo de estudo é medição, a carga de trabalho é constituída
por requisições de leitura e escrita enviadas para o sistema de armazenamento a
partir de instâncias da aplicação de execução dos testes (mais detalhes estão na
seção \ref{sec:aplicacao_de_execucao_dos_testes}.
